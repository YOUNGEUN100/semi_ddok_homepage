<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	

	<mapper namespace="com.example.mini.mapper.CommunityMapper">
	
	<!--커뮤니티 전체 리스트-->
		<select id="selectComList" parameterType="hashmap" resultType="com.example.mini.model.Community">
			SELECT 
				BOARD_NO, 
				B.USER_ID AS USER_ID,
				U.NICK AS NICK, 
				U.STATUS AS STATUS,
				TITLE, 
				CONTENT, 
				HITS, 
				CATEGORY, 
				DATE_FORMAT(CDATETIME,'%Y-%m-%d') AS CDATETIME, 
				DATE_FORMAT(UDATETIME,'%Y-%m-%d') AS UDATETIME, 
				DELETE_YN
			FROM T4_BOARD B
			LEFT JOIN (SELECT USER_ID, NICK, STATUS FROM T4_USER) U ON U.USER_ID = B.USER_ID
			WHERE BOARD_KIND = 'COM' AND DELETE_YN = 'N'
			<if test = "order == 'recent'">
        	ORDER BY CDATETIME DESC
        	</if>
        	<if test = "order == 'view'">
        	ORDER BY HITS DESC
        	</if>
			LIMIT #{startNum}, 10
		</select>
		
		<!--커뮤니티 글 리스트 개수 -->
		<select id="selectComCnt" parameterType="hashmap" resultType="int">
	        SELECT COUNT(*) AS CNT
			FROM T4_BOARD
			WHERE BOARD_KIND = 'COM' AND DELETE_YN = 'N'
		</select>
		
	
		<!--커뮤니티 글보기-->
		<select id="selectComInfo" parameterType="hashmap" resultType="com.example.mini.model.Community">
			  SELECT 
				BOARD_NO, 
				B.USER_ID AS USER_ID,
				U.NICK AS NICK, 
				U.STATUS AS STATUS,
				TITLE, 
				CONTENT, 
				HITS, 
				CATEGORY, 
				CDATETIME, 
				UDATETIME, 
				DELETE_YN
			FROM T4_BOARD B
			LEFT JOIN (SELECT USER_ID, NICK, STATUS FROM T4_USER) U ON U.USER_ID = B.USER_ID
			WHERE BOARD_KIND = 'COM'
			<if test="boardNo != '' and boardNo != null">
			AND BOARD_NO = #{boardNo}
			</if>
		</select>
	
		
		
		
		<!-- 커뮤니티 등록 -->
		<insert id="insertCom" parameterType="HashMap" useGeneratedKeys="true" keyProperty="id" keyColumn="board_no">
			INSERT INTO T4_BOARD (
				BOARD_KIND,
				BOARD_NO, 
				USER_ID, 
				TITLE, 
				CONTENT, 
				CATEGORY, 
				CDATETIME, 
				UDATETIME,
				DELETE_YN)
			VALUES ('COM', NULL, #{userId}, #{title}, #{content}, 1, now(), now(),'N')
		</insert>
		
		<!-- 커뮤니티 글 수정 -->
		<update id="updateCom" parameterType="hashmap">
			UPDATE T4_BOARD
			SET TITLE = #{title},
				CONTENT = #{content},
				UDATETIME = NOW()
			WHERE BOARD_NO = #{boardNo}
		</update>
		
		
		<!--커뮤니티 조회수-->
		<update id="updateComCnt" parameterType="hashmap">
			UPDATE T4_BOARD
			SET HITS = HITS + 1
			WHERE BOARD_NO = #{boardNo}
		</update>
		
		
		<!-- 첨부파일 등록 -->
		<insert id="insertFile" parameterType="HashMap" useGeneratedKeys="true" keyProperty="id" keyColumn="board_no">
			INSERT INTO T4_FILES (
				FILE_NO, 
				BOARD_NO, 
				ORLG_NAME, 
				SAVE_NAME, 
				FILE_PATH, 
				FILE_SIZE, 
				FILE_KIND,
				CDATETIME)
			VALUES (NULL, #{boardNo}, #{orlgName}, #{saveName}, #{filePath}, #{fileSize}, #{fileKind}, now())
		</insert>
		
		<!-- 커뮤니티 게시글 삭제 -->
		<update id="deleteCom" parameterType="hashmap">
			UPDATE T4_BOARD
			SET DELETE_YN = 'Y'
			WHERE BOARD_NO = #{boardNo}
		</update>
		
		<!--댓글 리스트 -->
		<select id="selectComment" parameterType="hashmap" resultType="com.example.mini.model.Community">
			SELECT 
				COMMENT_NO,
				BOARD_NO,
				C.USER_ID, 
				CONTENT AS COMMENT, 
				CDATETIME, 
				UDATETIME,
				U.NICK AS NICK
			FROM T4_COMMENT C
			LEFT JOIN T4_USER U ON U.USER_ID = C.USER_ID
			WHERE BOARD_NO = #{boardNo}
		</select>
	
	</mapper>